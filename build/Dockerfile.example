# Stage 0
# Build the binaries
FROM golang:1.23-alpine
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .

# Build all binaries
RUN go build -o ./bin/outpost ./cmd/outpost/main.go && \
    go build -o ./bin/outpost-server ./cmd/outpost-server/main.go && \
    go build -o ./bin/outpost-migrate-redis ./cmd/outpost-migrate-redis/main.go

# Stage 1
# Get busybox shell for entrypoint script
FROM busybox:1.36-musl AS busybox

# Stage 2
# Copy binaries to a new image
FROM gcr.io/distroless/base-debian12:nonroot

# Copy statically linked shell from busybox for entrypoint script
COPY --from=busybox /bin/sh /bin/sh

# Copy all binaries
COPY --from=0 /app/bin/outpost /usr/local/bin/outpost
COPY --from=0 /app/bin/outpost-server /usr/local/bin/outpost-server
COPY --from=0 /app/bin/outpost-migrate-redis /usr/local/bin/outpost-migrate-redis

# Copy entrypoint script
COPY --from=0 /app/build/entrypoint.sh /usr/local/bin/entrypoint.sh

# Default entrypoint runs migrations and starts server
ENTRYPOINT ["/bin/sh", "/usr/local/bin/entrypoint.sh"]
